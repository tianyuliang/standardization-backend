# 编码规则管理接口流程说明文档

> 文档版本：1.0
> 创建日期：2026-02-04
> 适用版本：standardization-backend v1.0+

---

## 一、业务概述

### 1.1 功能描述

编码规则管理模块用于管理系统中的编码规则，支持以下核心功能：

- **规则创建**：支持正则表达式（REGEX）和自定义配置（CUSTOM）两种类型
- **规则查询**：支持按目录、关键字、状态、类型等多维度查询
- **规则修改**：支持版本控制，修改时自动递增版本号
- **规则停用/启用**：支持停用规则，停用时必须填写停用原因
- **规则删除**：支持批量删除，删除后自动推送MQ消息
- **目录移动**：支持将规则移动到指定目录
- **关联查询**：支持查询规则被哪些数据元引用
- **关联文件**：支持关联标准文件

### 1.2 基础路径

```
基础路径：/api/standardization/v1/rule
```

### 1.3 接口清单（共18个）

| 序号 | 方法 | 路径 | 功能说明 | 标签 |
|------|------|------|----------|------|
| 1 | POST | `/v1/rule` | 新增编码规则 | open |
| 2 | PUT | `/v1/rule/{id}` | 根据ID修改编码规则 | open |
| 3 | GET | `/v1/rule/{id}` | 编码规则-详情查看 | open |
| 4 | GET | `/v1/rule/internal/getId/{id}` | 根据ID查看详情（内部） | - |
| 5 | GET | `/v1/rule/internal/getDetailByDataId/{dataId}` | 根据数据元ID查看详情（内部） | - |
| 6 | GET | `/v1/rule/internal/getDetailByDataCode/{dataCode}` | 根据数据元编码查看详情（内部） | - |
| 7 | GET | `/v1/rule` | 编码规则-列表查询 | open |
| 8 | DELETE | `/v1/rule/{ids}` | 编码规则-删除&批量删除 | - |
| 9 | PUT | `/v1/rule/state/{id}` | 根据编码规则id停用/启用 | open |
| 10 | POST | `/v1/rule/catalog/remove` | 编码规则-移动到指定目录 | - |
| 11 | GET | `/v1/rule/relation/de/{id}` | 分页查询引用编码规则的标准数据元列表 | - |
| 12 | POST | `/v1/rule/queryByIds` | 根据id列表查询 | open |
| 13 | POST | `/v1/rule/internal/queryByIds` | 根据id列表查询（内部） | - |
| 14 | GET | `/v1/rule/queryByStdFileCatalog` | 根据标准文件目录结构分页查询 | open |
| 15 | GET | `/v1/rule/queryByStdFile` | 根据标准文件分页查询 | open |
| 16 | GET | `/v1/rule/queryDataExists` | 编码规则-查询数据是否存在 | - |
| 17 | GET | `/v1/rule/relation/stdfile/{id}` | 根据文件ID分页查询编码规则关联的标准文件 | open |
| 18 | GET | `/v1/rule/getCustomDateFormat` | 获取自定义规则日期格式化字符串 | - |

---

## 二、数据库表结构

### 2.1 编码规则表（t_rule）

```sql
CREATE TABLE `t_rule` (
  `f_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `f_name` varchar(128) NOT NULL COMMENT '规则名称',
  `f_catalog_id` bigint(20) NOT NULL COMMENT '所属目录id',
  `f_org_type` INT(2) NOT NULL COMMENT '标准组织类型',
  `f_description` varchar(300) DEFAULT NULL COMMENT '说明',
  `f_rule_type` INT(2) NOT NULL DEFAULT 0 COMMENT '规则类型：0-正则表达式，1-自定义配置',
  `f_version` int(4) NOT NULL DEFAULT 1 COMMENT '版本号，从1开始',
  `f_expression` varchar(1024) NOT NULL COMMENT '表达式：正则表达式或JSON配置',
  `f_state` INT(2) NOT NULL DEFAULT 1 COMMENT '状态：1-启用，0-停用',
  `f_disable_reason` VARCHAR(1024) NULL COMMENT '停用原因',
  `f_authority_id` varchar(100) DEFAULT NULL COMMENT '权限域',
  `f_department_ids` varchar(350) NULL COMMENT '部门ID',
  `f_third_dept_id` varchar(36) NULL COMMENT '第三方部门ID',
  `f_create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `f_create_user` varchar(128) DEFAULT NULL COMMENT '创建用户',
  `f_update_time` datetime DEFAULT NULL COMMENT '修改时间',
  `f_update_user` varchar(128) DEFAULT NULL COMMENT '修改用户',
  `f_deleted` bigint(20) NOT NULL DEFAULT 0 COMMENT '逻辑删除标记',
  KEY `uk_name_orgtype_deleted` (f_name,f_org_type,f_deleted,f_department_ids),
  PRIMARY KEY (`f_id`)
) COMMENT='编码规则';
```

### 2.2 编码规则-文件关系表（t_relation_rule_file）

```sql
CREATE TABLE `t_relation_rule_file` (
  `f_id` bigint(20) NOT NULL COMMENT '主键',
  `f_rule_id` bigint(20) NOT NULL COMMENT '规则ID',
  `f_file_id` bigint(20) NOT NULL COMMENT '文件ID',
  UNIQUE KEY `uk_ruleid_fileid` (`f_rule_id`,`f_file_id`),
  PRIMARY KEY (`f_id`)
) COMMENT='编码规则-文件关系表';
```

---

## 三、枚举定义

### 3.1 标准分类枚举（OrgTypeEnum）

| 枚举值 | code | 说明 |
|--------|------|------|
| GROUP | 0 | 团体标准 |
| ENTERPRISE | 1 | 企业标准 |
| INDUSTRY | 2 | 行业标准 |
| LOCAL | 3 | 地方标准 |
| NATIONAL | 4 | 国家标准 |
| INTERNATIONAL | 5 | 国际标准 |
| FOREIGN | 6 | 国外标准 |
| OTHER | 99 | 其他标准 |

### 3.2 规则类型枚举（RuleTypeEnum）

| 枚举值 | code | 说明 |
|--------|------|------|
| REGEX | 0 | 正则表达式 |
| CUSTOM | 1 | 自定义配置 |

### 3.3 启用停用状态枚举（EnableDisableStatusEnum）

| 枚举值 | code | 说明 |
|--------|------|------|
| ENABLE | 1 | 启用 |
| DISABLE | 0 | 停用 |

---

## 四、接口详细说明

### 4.1 新增编码规则

**接口路径**：`POST /api/standardization/v1/rule`

#### 请求参数

```json
{
  "catalogId": 33,
  "name": "规则名称",
  "orgType": 0,
  "ruleType": "REGEX",
  "regex": "[A-Z]{4}\\d{6}",
  "description": "规则说明",
  "stdFiles": [1, 2, 3],
  "state": "enable",
  "departmentIds": "a/ab"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | String | 是 | 规则名称，最大128字符 |
| orgType | Integer | 是 | 标准分类，0-99 |
| ruleType | String | 是 | 规则类型：REGEX/CUSTOM |
| regex | String | 条件 | 正则表达式，ruleType=REGEX时必填 |
| custom | List | 条件 | 自定义配置，ruleType=CUSTOM时必填 |
| catalogId | Long | 否 | 所属目录ID，默认33 |
| description | String | 否 | 规则说明，最大300字符 |
| stdFiles | List<Long> | 否 | 关联的标准文件ID数组 |
| state | String | 否 | enable/disable |
| departmentIds | String | 否 | 部门ID |

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": { ... }
}
```

#### 业务逻辑

```
1. 参数校验
2. 业务校验（目录存在性、名称唯一性）
3. 表达式校验（REGEX正则有效性/CUSTOM配置）
4. 数据处理（生成ID、设置创建信息）
5. 保存数据库
6. 发送MQ消息
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.InvalidParameter | name | 规则名称已存在 | 同orgType下名称重复 |
| 2 | Standardization.InvalidParameter | catalog_id | 目录id[%s]对应的目录不存在 | 目录不存在 |
| 3 | Standardization.InvalidParameter | regex | 正则表达式为空 | ruleType=REGEX时regex为空 |
| 4 | Standardization.InvalidParameter | regex | 正则表达式非法 | 正则表达式格式错误 |
| 5 | Standardization.InvalidParameter | custom | 不能为空 | ruleType=CUSTOM时custom为空 |
| 6 | Standardization.InvalidParameter | custom[N].segment_length | 值必须为正整数 | 分段长度<=0 |
| 7 | Standardization.InvalidParameter | custom[N].value | 码表的唯一标识格式不正确 | DICT类型value格式错误 |
| 8 | Standardization.InvalidParameter | custom[N].value | 码表不存在 | DICT类型对应码表不存在 |
| 9 | Standardization.InvalidParameter | custom[N].value | 不能为空 | DATE/SPLIT_STR类型value为空 |
| 10 | Standardization.InvalidParameter | custom[N].value | 不支持的日期格式 | DATE类型格式不支持 |

**支持的日期格式**：yyyy, yyyyMM, yyyy-MM-dd, yyyyMMdd, yyyy-MM-dd HH:mm:ss, yyyyMMddHHmmss, yyyy-MM-dd'T'HH:mm:ss, yyyyMMdd'T'HHmmss, HHmmss, HH:mm:ss

---

### 4.2 修改编码规则

**接口路径**：`PUT /api/standardization/v1/rule/{id}`

#### 请求参数

```json
{
  "name": "修改后的规则名称",
  "orgType": 0,
  "ruleType": "REGEX",
  "regex": "[A-Z]{4}\\d{8}",
  "description": "修改后的规则说明"
}
```

#### 响应参数

同新增接口返回格式

#### 业务逻辑

```
1. 校验规则是否存在
2. 校验目录是否存在
3. 版本变更检测（名称/目录/部门/分类/说明/类型/表达式/关联文件）
4. 无变更直接返回原数据
5. 有变更则更新数据（版本号+1、更新关联文件）
6. 发送MQ消息
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.DATA_NOT_EXIST | id | 记录不存在 | 规则ID不存在 |
| 2 | Standardization.InvalidParameter | name | 规则名称已存在 | 修改时名称与其他记录重复 |
| 3 | Standardization.InvalidParameter | catalog_id | 目录id[%s]对应的目录不存在 | 目录不存在 |

---

### 4.3 查看规则详情

**接口路径**：`GET /api/standardization/v1/rule/{id}`

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": {
    "id": 1234567890,
    "name": "规则名称",
    "catalogId": 33,
    "catalogName": "全部目录",
    "orgType": 0,
    "ruleType": "REGEX",
    "version": 1,
    "regex": "[A-Z]{4}\\d{6}",
    "description": "规则说明",
    "state": "enable",
    "usedFlag": false,
    ...
  }
}
```

#### 业务逻辑

```
1. 查询规则基本信息
2. 查询目录信息
3. 根据ruleType解析expression
4. 查询关联文件
5. 查询部门信息
6. 查询是否被引用
```

#### 异常提示

**本接口无异常抛出**，记录不存在时返回null（code=0）。

---

### 4.4 规则列表查询

**接口路径**：`GET /api/standardization/v1/rule`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| catalog_id | Long | 否 | 目录ID |
| keyword | String | 否 | 搜索关键字 |
| org_type | Integer | 否 | 标准分类：0-99 |
| state | String | 否 | enable/disable |
| rule_type | String | 否 | REGEX/CUSTOM |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |
| sort | String | 否 | 排序字段 |
| direction | String | 否 | asc/desc |
| department_id | String | 否 | 部门ID |

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": [...],
  "totalCount": 100
}
```

#### 业务逻辑

```
1. 处理目录ID（获取当前目录及所有子目录ID列表）
2. 构建查询条件
3. 分页查询
4. 数据处理（解析expression、查询目录/部门/引用状态）
```

#### 异常提示

**本接口无异常抛出**。

---

### 4.5 删除编码规则

**接口路径**：`DELETE /api/standardization/v1/rule/{ids}`

#### 请求参数

- 路径参数：ids（多个ID用英文逗号分隔）

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": null
}
```

#### 业务逻辑

```
1. 解析ID列表
2. 物理删除t_rule记录
3. 同步删除t_relation_rule_file关联记录
4. 发送MQ消息（操作类型：delete）
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.InvalidParameter | ids | ids 不能为空 | 批量删除时ids为空 |

---

### 4.6 启用/停用规则

**接口路径**：`PUT /api/standardization/v1/rule/state/{id}`

#### 请求参数

```json
{
  "state": "disable",
  "reason": "停用原因"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| state | String | 是 | enable/disable |
| reason | String | 条件 | 停用原因，state=disable时必填，不超过800字符 |

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": null
}
```

#### 业务逻辑

```
1. 校验规则是否存在
2. state=disable时校验停用原因（必填且<=800字符）
3. 更新状态（enable清空disable_reason，disable设置disable_reason）
4. 发送MQ消息
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.DATA_NOT_EXIST | id | 数据不存在 | 规则ID不存在 |
| 2 | Standardization.PARAMETER_EMPTY | disable_reason | 停用必须填写停用原因 | state=disable时reason为空 |
| 3 | Standardization.InvalidParameter | disable_reason | 长度超过800 | 停用原因超过800字符 |

---

### 4.7 目录移动

**接口路径**：`POST /api/standardization/v1/rule/catalog/remove`

#### 请求参数

```json
{
  "ids": [1, 2, 3],
  "catalogId": 331
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| ids | List<Long> | 是 | 规则ID列表 |
| catalogId | Long | 是 | 目标目录ID |

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": null
}
```

#### 业务逻辑

```
1. 校验目标目录是否存在且类型为编码规则
2. 批量更新规则的catalog_id
3. 被移动的规则版本号+1
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.InvalidParameter | catalog_id | 目录id[%s]对应的目录不存在 | 目标目录不存在或类型不符 |

---

### 4.8 查询引用规则的数据元列表

**接口路径**：`GET /api/standardization/v1/rule/relation/de/{id}`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 规则ID |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |

#### 响应参数

返回分页的数据元列表

#### 业务逻辑

```
1. 校验规则是否存在
2. 查询引用该规则的数据元列表
3. 返回分页结果
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.DATA_NOT_EXIST | id | 记录不存在 | 规则ID不存在 |

---

### 4.9 批量查询规则

**接口路径**：`POST /api/standardization/v1/rule/queryByIds`

#### 请求参数

```json
{
  "ids": [1, 2, 3]
}
```

#### 响应参数

返回规则详情列表

#### 业务逻辑

```
1. 校验ids不为空
2. 批量查询规则详情
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 | 触发场景 |
|------|--------|------|----------|----------|
| 1 | Standardization.InvalidParameter | ids | ids 不能为空 | 批量查询时ids为空 |

---

### 4.10 根据标准文件目录查询

**接口路径**：`GET /api/standardization/v1/rule/queryByStdFileCatalog`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| catalog_id | Long | 是 | 标准文件目录ID |
| keyword | String | 否 | 搜索关键字 |
| org_type | Integer | 否 | 标准分类 |
| state | String | 否 | enable/disable |
| rule_type | String | 否 | REGEX/CUSTOM |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |
| sort | String | 否 | 排序字段 |
| direction | String | 否 | 排序方向 |

#### 特殊说明

- catalog_id=-1：查询未关联任何标准文件的规则
- 顶级目录：返回所有规则

#### 异常提示

**本接口无异常抛出**。

---

### 4.11 根据标准文件查询

**接口路径**：`GET /api/standardization/v1/rule/queryByStdFile`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file_id | Long | 是 | 标准文件ID |
| keyword | String | 否 | 搜索关键字 |
| org_type | Integer | 否 | 标准分类 |
| state | String | 否 | enable/disable |
| rule_type | String | 否 | REGEX/CUSTOM |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |
| sort | String | 否 | 排序字段 |
| direction | String | 否 | 排序方向 |
| department_id | String | 否 | 部门ID |

#### 异常提示

**本接口无异常抛出**。

---

### 4.12 查询数据是否存在

**接口路径**：`GET /api/standardization/v1/rule/queryDataExists`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | String | 是 | 规则名称 |
| filter_id | Long | 否 | 过滤ID（用于修改时排除自身） |
| department_ids | String | 否 | 部门ID |

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": true
}
```

返回true表示存在，false表示不存在。

#### 异常提示

**本接口无异常抛出**。

---

### 4.13 查询规则关联的标准文件

**接口路径**：`GET /api/standardization/v1/rule/relation/stdfile/{id}`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 规则ID |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |

#### 异常提示

**本接口无异常抛出**。

---

### 4.14 获取自定义日期格式列表

**接口路径**：`GET /api/standardization/v1/rule/getCustomDateFormat`

#### 响应参数

```json
{
  "code": 0,
  "description": "操作成功",
  "data": ["yyyy", "yyyyMM", "yyyy-MM-dd", ...]
}
```

#### 异常提示

**本接口无异常抛出**。

---

### 4.15 内部接口

#### 4.15.1 根据ID查看详情（内部）

**接口路径**：`GET /v1/rule/internal/getId/{id}`

**异常提示**：同4.3（无异常抛出）

#### 4.15.2 根据数据元ID查看详情（内部）

**接口路径**：`GET /v1/rule/internal/getDetailByDataId/{dataId}`

**异常提示**：数据元不存在或无关联规则时返回null

#### 4.15.3 根据数据元编码查看详情（内部）

**接口路径**：`GET /v1/rule/internal/getDetailByDataCode/{dataCode}`

**异常提示**：数据元不存在或无关联规则时返回null

#### 4.15.4 批量查询（内部）

**接口路径**：`POST /v1/rule/internal/queryByIds`

**异常提示**：同4.9（ids为空时抛Standardization.InvalidParameter）

---

## 五、错误响应标准格式

### 5.1 单条错误

```json
{
  "code": "Standardization.InvalidParameter",
  "description": "参数值校验不通过",
  "detail": [
    { "Key": "name", "Message": "规则名称已存在" }
  ],
  "solution": "请使用请求参数构造规范化的请求字符串。详细信息参见产品 API 文档。"
}
```

### 5.2 多条错误

```json
{
  "code": "Standardization.InvalidParameter",
  "description": "参数值校验不通过",
  "detail": [
    { "Key": "regex", "Message": "正则表达式为空" },
    { "Key": "custom[0].segment_length", "Message": "值必须为正整数" }
  ],
  "solution": "请使用请求参数构造规范化的请求字符串。详细信息参见产品 API 文档。"
}
```

### 5.3 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| code | String | 错误码，格式：模块名.错误类型 |
| description | String | 错误描述 |
| detail | Array | 详细错误列表 |
| detail[].Key | String | 错误字段名 |
| detail[].Message | String | 错误信息 |
| solution | String | 解决方案提示 |

---

## 六、异常码汇总

### 6.1 按接口统计

| 接口 | 异常数量 | 涉及错误码 |
|------|----------|------------|
| 4.1 新增编码规则 | 10 | InvalidParameter |
| 4.2 修改编码规则 | 3 | DATA_NOT_EXIST, InvalidParameter |
| 4.3 查看规则详情 | 0 | - |
| 4.4 规则列表查询 | 0 | - |
| 4.5 删除编码规则 | 1 | InvalidParameter |
| 4.6 启用/停用规则 | 3 | DATA_NOT_EXIST, PARAMETER_EMPTY, InvalidParameter |
| 4.7 目录移动 | 1 | InvalidParameter |
| 4.8 查询引用数据元 | 1 | DATA_NOT_EXIST |
| 4.9 批量查询规则 | 1 | InvalidParameter |
| 4.10 根据标准文件目录查询 | 0 | - |
| 4.11 根据标准文件查询 | 0 | - |
| 4.12 查询数据是否存在 | 0 | - |
| 4.13 查询关联标准文件 | 0 | - |
| 4.14 获取日期格式列表 | 0 | - |
| 4.15 内部接口 | 0-1 | 同对应外部接口 |

### 6.2 错误码清单

| 错误码 | 说明 | 使用接口 |
|--------|------|----------|
| Standardization.DATA_NOT_EXIST | 数据不存在 | 4.2, 4.6, 4.8 |
| Standardization.PARAMETER_EMPTY | 参数为空 | 4.6 |
| Standardization.InvalidParameter | 参数无效 | 4.1, 4.2, 4.5, 4.6, 4.7, 4.8, 4.9 |

---

> 文档结束
