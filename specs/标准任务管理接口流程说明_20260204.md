# 标准任务管理接口流程说明文档

> 文档版本：2.0（完整版）
> 创建日期：2026-02-04
> 更新时间：2026-02-06
> 适用版本：standardization-backend v1.0+

---

## 一、业务概述

### 1.1 功能描述

标准任务管理模块用于管理系统中的标准创建任务，支持以下核心功能：

- **任务管理**：标准创建任务的查询、创建、完成
- **标准推荐**：调用外部推荐算法获取标准推荐
- **规则推荐**：调用外部推荐算法获取编码规则推荐
- **业务表管理**：待新建标准关联的业务表管理

### 1.2 基础路径

```
基础路径：/api/standardization/v1/dataelement/task
```

### 1.3 接口清单（共24个）

| 序号 | 方法 | 路径 | 功能说明 |
|------|------|------|----------|
| 1 | GET | `/v1/dataelement/task/std-create/uncompleted` | 未处理任务列表 |
| 2 | GET | `/v1/dataelement/task/std-create/completed` | 已完成任务列表 |
| 3 | GET | `/v1/dataelement/task/std-create/completed/{id}` | 任务详情 |
| 4 | POST | `/v1/dataelement/task/std-create/relation/staging` | 标准关联暂存 |
| 5 | POST | `/v1/dataelement/task/std-create/publish/submit` | 标准关联提交 |
| 6 | POST | `/v1/dataelement/task/addToPending` | 添加至待新建 |
| 7 | GET | `/v1/dataelement/task/getBusinessTable` | 业务表列表 |
| 8 | GET | `/v1/dataelement/task/getBusinessTableField` | 业务表字段列表 |
| 9 | DELETE | `/v1/dataelement/task/deleteBusinessTableField/{id}` | 移除字段 |
| 10 | POST | `/v1/dataelement/task/createTask` | 新建标准任务 |
| 11 | PUT | `/v1/dataelement/task/cancelBusinessTableField` | 撤销 |
| 12 | GET | `/v1/dataelement/task/getBusinessTableFromTask` | 任务关联业务表 |
| 13 | GET | `/v1/dataelement/task/getBusinessTableFieldFromTask` | 任务关联字段 |
| 14 | POST | `/v1/dataelement/task/submitDataElement` | 提交选定数据元 |
| 15 | POST | `/v1/dataelement/task/finishTask/{task_id}` | 完成任务 |
| 16 | POST | `/v1/dataelement/task/queryTaskProcess` | 进度查询 |
| 17 | POST | `/v1/dataelement/task/queryTaskState` | 任务状态查询 |
| 18 | PUT | `/v1/dataelement/task/updateDescription` | 修改字段说明 |
| 19 | PUT | `/v1/dataelement/task/accept` | 采纳 |
| 20 | PUT | `/v1/dataelement/task/updateTableName` | 修改表名称 |
| 21 | POST | `/v1/dataelement/task/std-rec/rec` | 标准推荐（内部） |
| 22 | POST | `/v1/dataelement/task/std-create` | 标准创建（内部） |
| 23 | POST | `/v1/dataelement/task/stand-rec/rec` | 标准推荐（弹框） |
| 24 | POST | `/v1/dataelement/task/rule-rec/rec` | 编码规则推荐 |

---

## 二、数据库表结构

### 2.1 标准创建任务表（t_task_std_create）

```sql
CREATE TABLE `t_task_std_create` (
  `f_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `f_task_no` varchar(64) NOT NULL COMMENT '任务编号',
  `f_table` varchar(128) DEFAULT NULL COMMENT '业务表名称',
  `f_table_description` varchar(256) DEFAULT NULL COMMENT '业务表描述',
  `f_table_field` varchar(1024) DEFAULT NULL COMMENT '表字段名称',
  `f_status` INT(2) NOT NULL DEFAULT 0 COMMENT '任务状态：0-未处理，1-处理中，2-处理完成',
  `f_create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `f_create_user` varchar(128) DEFAULT NULL COMMENT '创建用户（ID）',
  `f_create_user_phone` varchar(32) DEFAULT NULL COMMENT '创建用户联系方式',
  `f_update_time` datetime DEFAULT NULL COMMENT '修改时间',
  `f_update_user` varchar(128) DEFAULT NULL COMMENT '修改用户（ID）',
  `f_webhook` varchar(256) DEFAULT NULL COMMENT 'AF回调地址',
  `f_deleted` bigint(20) NOT NULL DEFAULT 0 COMMENT '逻辑删除标记',
  PRIMARY KEY (`f_id`),
  KEY `idx_task_no` (`f_task_no`),
  KEY `idx_status_deleted` (`f_status`,`f_deleted`)
) COMMENT='标准创建任务表';
```

### 2.2 标准创建任务结果表（t_task_std_create_result）

```sql
CREATE TABLE `t_task_std_create_result` (
  `f_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `f_task_id` bigint(20) NOT NULL COMMENT '标准推荐任务ID',
  `f_table_field` varchar(64) DEFAULT NULL COMMENT '表字段名称',
  `f_table_field_description` varchar(256) DEFAULT NULL COMMENT '表字段描述',
  `f_std_ref_file` varchar(256) DEFAULT NULL COMMENT '参考标准文件',
  `f_std_code` varchar(64) DEFAULT NULL COMMENT '标准编码',
  `f_rec_std_codes` varchar(512) DEFAULT NULL COMMENT '推荐算法结果标准编码',
  `f_std_ch_name` varchar(128) DEFAULT NULL COMMENT '标准中文名称',
  `f_std_en_name` varchar(256) DEFAULT NULL COMMENT '标准英文名称',
  PRIMARY KEY (`f_id`),
  KEY `idx_task_id` (`f_task_id`)
) COMMENT='标准创建任务结果表';
```

### 2.3 待新建标准表（t_business_table_std_create_pool）

```sql
CREATE TABLE `t_business_table_std_create_pool` (
  `f_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `f_table_name` varchar(128) NOT NULL COMMENT '业务表名称',
  `f_table_description` varchar(256) DEFAULT NULL COMMENT '业务表描述',
  `f_table_field` varchar(2048) DEFAULT NULL COMMENT '表字段',
  `f_status` INT(2) NOT NULL DEFAULT 0 COMMENT '状态：0-待新建，1-处理中，2-已完成',
  `f_create_user` varchar(128) DEFAULT NULL COMMENT '创建用户',
  `f_create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `f_deleted` bigint(20) NOT NULL DEFAULT 0 COMMENT '逻辑删除标记',
  PRIMARY KEY (`f_id`)
) COMMENT='待新建标准表';
```

---

## 三、枚举定义

### 3.1 任务状态枚举

| 枚举值 | code | 说明 |
|--------|------|------|
| UNHANDLED | 0 | 未处理 |
| PROCESSING | 1 | 处理中 |
| COMPLETED | 2 | 处理完成 |

---

## 四、数据模型定义

### 4.1 标准推荐请求（CustomTaskRecDto）

```json
{
  "taskId": 123,
  "businessTable": "业务表名",
  "tableField": "字段名",
  "tableFieldDescription": "字段描述",
  "dataType": "VARCHAR"
}
```

### 4.2 标准推荐响应

```json
{
  "code": "0",
  "description": "操作成功",
  "data": [
    {
      "stdCode": "GB/T 1.1",
      "stdName": "标准名称",
      "matchRate": 95.5
    }
  ]
}
```

### 4.3 任务详情响应

```json
{
  "id": 1234567890,
  "taskNo": "TASK20240206001",
  "table": "业务表名",
  "tableDescription": "业务表描述",
  "status": 0,
  "createTime": "2022-11-21 12:00:00",
  "createUser": "用户A",
  "createUserPhone": "13800138000",
  "webhook": "https://af.example.com/callback"
}
```

### 4.4 任务结果详情

```json
{
  "id": 1234567890,
  "taskId": 123,
  "tableField": "字段名",
  "tableFieldDescription": "字段描述",
  "stdRefFile": "参考标准文件",
  "stdCode": "GB/T 1.1",
  "recStdCodes": "GB/T 1.1,GB/T 1.2",
  "stdChName": "标准中文名称",
  "stdEnName": "标准英文名称"
}
```

---

## 五、接口详细说明

### 5.1 未处理任务列表

**接口路径**：`GET /api/standardization/v1/dataelement/task/std-create/uncompleted`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | String | 否 | 搜索关键字 |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |

---

### 5.2 已完成任务列表

**接口路径**：`GET /api/standardization/v1/dataelement/task/std-create/completed`

---

### 5.3 任务详情

**接口路径**：`GET /api/standardization/v1/dataelement/task/std-create/completed/{id}`

#### 响应参数

返回任务详情及任务结果列表

---

### 5.4 标准关联暂存

**接口路径**：`POST /api/standardization/v1/dataelement/task/std-create/relation/staging`

#### 请求参数

```json
{
  "taskId": 123,
  "businessTable": "业务表名",
  "fields": [
    {
      "fieldName": "字段名",
      "fieldDescription": "字段描述",
      "dataType": "VARCHAR"
    }
  ]
}
```

---

### 5.5 标准关联提交

**接口路径**：`POST /api/standardization/v1/dataelement/task/std-create/publish/submit`

#### 请求参数

同暂存接口

#### 业务逻辑

```
1. 保存任务数据
2. 异步调用推荐算法
3. 返回推荐结果
```

---

### 5.6 添加至待新建

**接口路径**：`POST /api/standardization/v1/dataelement/task/addToPending`

#### 请求参数

```json
{
  "businessTable": "业务表名",
  "businessTableDescription": "业务表描述",
  "tableField": "字段名1,字段名2",
  "createUserPhone": "13800138000"
}
```

---

### 5.7 业务表列表

**接口路径**：`GET /api/standardization/v1/dataelement/task/getBusinessTable`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | String | 否 | 搜索关键字 |
| offset | Integer | 否 | 分页页码，默认1 |
| limit | Integer | 否 | 条数，默认20 |

---

### 5.8 业务表字段列表

**接口路径**：`GET /api/standardization/v1/dataelement/task/getBusinessTableField`

---

### 5.9 新建标准任务

**接口路径**：`POST /api/standardization/v1/dataelement/task/createTask`

#### 请求参数

```json
{
  "businessTableIds": [1, 2, 3],
  "webhook": "https://af.example.com/callback"
}
```

---

### 5.10 完成任务

**接口路径**：`POST /api/standardization/v1/dataelement/task/finishTask/{task_id}`

#### 业务逻辑

```
1. 更新任务状态为完成
2. 发送结果到AF系统
```

---

### 5.11 标准推荐（内部）

**接口路径**：`POST /api/standardization/v1/dataelement/task/std-rec/rec`

#### 请求参数

```json
{
  "taskId": 123,
  "businessTable": "业务表名",
  "tableField": "字段名",
  "tableFieldDescription": "字段描述"
}
```

#### 业务逻辑

```
1. 调用外部推荐算法服务
2. 返回推荐结果（最多3条）
```

---

### 5.12 编码规则推荐

**接口路径**：`POST /api/standardization/v1/dataelement/task/rule-rec/rec`

#### 请求参数

```json
{
  "businessTable": "业务表名",
  "tableField": "字段名",
  "tableFieldDescription": "字段描述",
  "dataType": "VARCHAR"
}
```

---

## 六、MQ消息格式

### 6.1 任务完成消息

**Topic**: 任务完成回调

```json
{
  "taskId": 123,
  "status": "completed",
  "results": [...]
}
```

---

## 七、依赖服务说明

### 7.1 内部服务依赖

| 服务 | 用途 |
|------|------|
| AfStdTaskService | 标准任务核心服务 |
| TaskStdCreateMapper | 任务数据访问 |
| KafkaProducerService | 异步消息发送 |

### 7.2 外部服务

| 服务 | 用途 |
|------|------|
| 推荐算法服务（recServiceUrl） | 标准推荐 |
| 规则推荐服务（recRuleServiceUrl） | 规则推荐 |
| AF系统 | 任务回调 |

---

## 八、Go语言开发参考

### 8.1 关键Go结构体示例

```go
// 标准创建任务实体
type TaskStdCreate struct {
    ID                 int64   `json:"id" gorm:"primaryKey;column:f_id"`
    TaskNo             string  `json:"taskNo" gorm:"column:f_task_no"`
    Table              string  `json:"table" gorm:"column:f_table"`
    TableDescription    string  `json:"tableDescription" gorm:"column:f_table_description"`
    TableField         string  `json:"tableField" gorm:"column:f_table_field"`
    Status             int     `json:"status" gorm:"column:f_status"`
    CreateTime         string  `json:"createTime" gorm:"column:f_create_time"`
    CreateUser         string  `json:"createUser" gorm:"column:f_create_user"`
    CreateUserPhone    string  `json:"createUserPhone" gorm:"column:f_create_user_phone"`
    UpdateTime         string  `json:"updateTime" gorm:"column:f_update_time"`
    UpdateUser         string  `json:"updateUser" gorm:"column:f_update_user"`
    Webhook            string  `json:"webhook" gorm:"column:f_webhook"`
    Deleted            int     `json:"deleted" gorm:"column:f_deleted"`
}

// 任务结果实体
type TaskStdCreateResult struct {
    ID                   int64   `json:"id" gorm:"primaryKey;column:f_id"`
    TaskID               int64   `json:"taskId" gorm:"column:f_task_id"`
    TableField           string  `json:"tableField" gorm:"column:f_table_field"`
    TableFieldDescription string  `json:"tableFieldDescription" gorm:"column:f_table_field_description"`
    StdRefFile           string  `json:"stdRefFile" gorm:"column:f_std_ref_file"`
    StdCode              string  `json:"stdCode" gorm:"column:f_std_code"`
    RecStdCodes          string  `json:"recStdCodes" gorm:"column:f_rec_std_codes"`
    StdChName            string  `json:"stdChName" gorm:"column:f_std_ch_name"`
    StdEnName            string  `json:"stdEnName" gorm:"column:f_std_en_name"`
}
```

---

> 文档结束

> 最后更新时间：2026-02-06
> 维护者：Claude Code
