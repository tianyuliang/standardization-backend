# 目录管理接口流程说明文档

> 文档版本：2.1（Java源码对照修正版）
> 创建日期：2026-02-04
> 更新时间：2026-02-26
> 适用版本：standardization-backend v1.0+

---

## 一、业务概述

### 1.1 功能描述

目录管理模块用于管理系统中的目录结构（Catalog），支持以下核心功能：

- **目录查询**：支持按类型、名称等多维度查询目录树或列表
- **目录创建**：支持创建多级目录
- **目录编辑**：支持修改目录信息
- **目录删除**：支持删除目录及其子集
- **目录移动**：支持移动目录到其他父级

### 1.2 基础路径

```
基础路径：/api/standardization/v1/catalog
```

### 1.3 接口清单（共8个）

| 序号 | 方法 | 路径 | 功能说明 | 状态 |
|------|------|------|----------|------|
| 1 | GET | `/v1/catalog/query_tree` | 查询目录树 | 有效 |
| 2 | GET | `/v1/catalog/query` | 检索目录 | 有效 |
| 3 | GET | `/v1/catalog/{id}` | 查看目录详情 | 已废弃 |
| 4 | POST | `/v1/catalog` | 创建目录 | 有效 |
| 5 | PUT | `/v1/catalog/{id}` | 修改目录 | 有效 |
| 6 | DELETE | `/v1/catalog/{id}` | 删除目录 | 有效 |
| 7 | GET | `/v1/catalog/query_tree_by_file` | 查询文件目录树 | 已废弃 |
| 8 | GET | `/v1/catalog/query/with_file` | 查询目录及文件树 | 有效 |

**说明**：
- 文档中提到的 `/v1/catalog/remove`（移除目录）和 `/v1/catalog/{id}/state`（启用/停用）在 Java 源码中未找到对应实现
- 这些接口可能在其他模块中实现，或者已被移除/重构

---

## 二、数据库表结构

### 2.1 目录表（t_de_catalog_info）

```sql
CREATE TABLE `t_de_catalog_info` (
  `f_id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '目录唯一标识',
  `f_catalog_name` varchar(20) NOT NULL COMMENT '目录名称',
  `f_description` varchar(300) DEFAULT NULL COMMENT '目录说明',
  `f_level` INT(4) NOT NULL DEFAULT 1 COMMENT '目录级别',
  `f_parent_id` bigint(20) DEFAULT NULL COMMENT '父级标识',
  `f_type` INT(2) NOT NULL COMMENT '目录类型',
  `f_authority_id` varchar(100) DEFAULT NULL COMMENT '权限域',
  `f_create_time` datetime DEFAULT NULL COMMENT '创建时间',
  `f_create_user` varchar(128) DEFAULT NULL COMMENT '创建用户',
  `f_update_time` datetime DEFAULT NULL COMMENT '修改时间',
  `f_update_user` varchar(128) DEFAULT NULL COMMENT '修改用户',
  `f_deleted` bigint(20) NOT NULL DEFAULT 0 COMMENT '逻辑删除标记',
  PRIMARY KEY (`f_id`),
  KEY `idx_parent_id` (`f_parent_id`),
  KEY `idx_type_deleted` (`f_type`,`f_deleted`)
) COMMENT='目录信息表';
```

---

## 三、枚举定义

### 3.1 目录类型枚举（CatalogTypeEnum）

| 枚举值 | code | 说明 |
|--------|------|------|
| Root | 0 | 根目录（系统内部使用） |
| DataElement | 1 | 数据元目录 |
| Dict | 2 | 码表目录 |
| ValueRule | 3 | 编码规则目录 |
| File | 4 | 文件目录 |
| Other | 99 | 其他类型 |

---

## 四、数据模型定义

### 4.1 创建目录请求

```json
{
  "catalogName": "目录名称",
  "parentId": 123,
  "description": "目录说明"
}
```

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| catalogName | String | 是 | 目录名称，1-20字符，由中英文、数字、下划线、中划线组成，且不能以下划线和中划线开头 |
| parentId | Long | 是 | 父级ID（必须指向已存在的目录） |
| type | Integer | 否 | 目录类型，自动继承父目录类型（1-数据元，2-码表，3-编码规则，4-文件） |
| description | String | 否 | 目录说明，最大300字符 |

**说明**：
- `type` 字段在创建时不需要传递，系统会自动从父目录继承
- 父目录必须是已存在的目录，且 level < 255
- 创建后目录 level = 父目录 level + 1

### 4.2 目录详情响应

```json
{
  "id": 33,
  "catalogName": "目录名称",
  "description": "目录说明",
  "level": 2,
  "parentId": 0,
  "type": 1,
  "children": [...]
}
```

### 4.3 统一响应结构

```json
{
  "code": "0",
  "description": "操作成功",
  "data": {...}
}
```

---

## 五、接口详细说明

### 5.1 查询目录树

**接口路径**：`GET /api/standardization/v1/catalog/query_tree`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| type | Integer | 条件 | 目录类型：1-数据元，2-码表，3-编码规则，4-文件（当id为空时必填） |
| id | Long | 条件 | 目录ID，指定则查询该目录及其子集（当id为空时type必填） |

**请求逻辑**：
- 如果 `id` 有值：查询指定目录及其子集的树形结构
- 如果 `id` 为空：根据 `type` 查询该类型所有根目录及其子集的树形结构
- `type` 参数校验：不能为空，且不能为 Root(0) 或 Other(99)

#### 响应参数

返回目录树结构，支持递归子级

#### 业务逻辑

```
1. 校验目录类型
2. 获取根目录列表
3. 递归获取子级目录
4. 返回树形结构
```

---

### 5.2 检索目录

**接口路径**：`GET /api/standardization/v1/catalog/query`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| type | Integer | 是 | 目录类型：1-数据元，2-码表，3-编码规则，4-文件 |
| catalog_name | String | 否 | 目录名称（模糊搜索，不区分大小写） |

**说明**：
- SQL 注入防护：catalog_name 会进行特殊字符转义
- 搜索结果不包含根目录（level > 1）
- 目录名称会被 trim 处理，最大截取前64字符
- 搜索使用 LIKE '%keyword%' 模式，且转换为小写匹配

#### 响应参数

返回平铺的目录列表

---

### 5.3 创建目录

**接口路径**：`POST /api/standardization/v1/catalog`

#### 请求参数

参考创建目录请求

#### 业务逻辑

```
1. 参数校验
2. 校验目录名称（长度、格式、重复）
3. 校验父级目录存在性
4. 校验目录类型（子目录继承父目录类型）
5. 生成目录ID
6. 保存数据库
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 |
|------|--------|------|----------|
| 1 | InvalidParameter | catalog_name | 目录名称不能为空 |
| 2 | InvalidParameter | catalog_name | 目录名称由长度不超过20个字符的中英文、数字、下划线、中划线组成,且不能以下划线和中划线开头 |
| 3 | InvalidParameter | parent_id | 父目录ID不能为空 |
| 4 | Empty | parent_id | 无法找到对应的父目录,请检查parent_id参数 |
| 5 | OutOfRange | parent_id | 目录级别取值范围(1-255) |
| 6 | InvalidParameter | - | 不能修改根目录（修改时） |
| 7 | InvalidParameter | parent_id | 新的父目录不能是自身及其子目录（修改时） |
| 8 | InvalidParameter | parent_id | 新的父目录类型不能与当前目录不一致（修改时） |
| 9 | OperationConflict | catalog_name | 同级目录名称不能重复 |

---

### 5.4 修改目录

**接口路径**：`PUT /api/standardization/v1/catalog/{id}`

#### 请求参数

```json
{
  "catalogName": "修改后的目录名称",
  "parentId": 123,
  "description": "修改后的目录说明"
}
```

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| catalogName | String | 否 | 目录名称（校验规则同创建） |
| parentId | Long | 否 | 父级ID（修改时可以移动目录） |
| description | String | 否 | 目录说明 |

#### 业务逻辑

```
1. 校验目录存在性
2. 校验目录名称（不重复、格式正确）
3. 如果传入parentId：
   - 不允许修改根目录（level <= 1）
   - 新的父目录不能是自身及其子目录
   - 新的父目录类型必须与当前目录一致
   - 继承父目录的level和type
4. 更新目录信息
```

---

### 5.5 删除目录

**接口路径**：`DELETE /api/standardization/v1/catalog/{id}`

#### 业务逻辑

```
1. 校验目录存在性
2. 不允许删除根目录（level <= 1）
3. 根据目录类型检查是否包含数据：
   - 数据元目录：检查是否有数据元
   - 码表目录：检查是否有码表
   - 编码规则目录：检查是否有编码规则
   - 文件目录：检查是否有文件
4. 递归删除所有子级目录
```

#### 异常提示

| 序号 | 错误码 | 字段 | 提示信息 |
|------|--------|------|----------|
| 1 | MissingParameter | id | 目录id参数不能为空 |
| 2 | Empty | id | 目录id指向的目录不能为空 |
| 3 | InvalidParameter | id | 不允许删除根目录 |
| 4 | DATA_EXIST | id | 目录或子目录下已存在数据元/码表/编码规则/文件，不允许删除 |

---

### 5.6 查询目录及文件树（仅限文件目录类型）

**接口路径**：`GET /api/standardization/v1/catalog/query/with_file`

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| catalog_name | String | 否 | 目录名称（模糊搜索） |

**说明**：
- 固定查询文件类型目录（type = 4）
- SQL 注入防护：catalog_name 会进行特殊字符转义
- 返回平铺列表（非树形结构）

#### 响应参数

```json
{
  "catalogs": [...],   // 目录列表
  "files": [...]       // 文件列表
}
```

---

## 六、目录名称校验规则

### 6.1 校验规则

| 规则 | 说明 |
|------|------|
| 正则表达式 | `^(?!_)(?!-)[\u4E00-\u9FA5\uF900-\uFA2D\w-]{1,20}$` |
| 长度 | 1-20个字符 |
| 字符集 | 中文、英文、数字、下划线(_)、中划线(-) |
| 首字符 | 不能以下划线或中划线开头 |

**正则表达式说明** (`getRegexENOrCNVarL(1, 20)`)：
- `^(?!_)` - 负向前瞻，不以 `_` 开头
- `^(?!-)` - 负向前瞻，不以 `-` 开头
- `[\u4E00-\u9FA5\uF900-\uFA2D\w-]` - 中文字符、字母、数字、下划线、中划线
- `{1,20}` - 长度 1-20

### 6.2 目录级别

- 范围：1-255
- 子目录继承父目录的level+1
- 父目录 level >= 255 时无法创建子目录

### 6.3 修改目录特殊校验

- 不允许修改根目录（level <= 1）
- 新的父目录不能是自身及其子目录
- 新的父目录类型必须与当前目录一致

---

## 七、依赖服务说明

### 7.1 内部服务依赖

| 服务 | 用途 |
|------|------|
| DeCatalogInfoMapper | 目录数据访问 |
| IDataElementInfoService | 数据元统计（按目录/文件分组计数） |
| IDictService | 码表统计（按目录/文件分组计数） |
| RuleService | 编码规则统计（按目录/文件分组计数） |
| StdFileMgrService | 文件统计（按目录分组计数） |
| IRelationDeFileService | 数据元文件关联 |
| RelationDictFileMapper | 码表文件关联 |
| RelationRuleFileMapper | 规则文件关联 |

### 7.2 特殊方法

| 方法 | 说明 |
|------|------|
| getIDList(catalogId) | 获取目录及其所有子目录的ID列表 |
| getCatalogCountMap(type) | 根据类型按目录分组统计数量 |
| getFileCountMap(type) | 根据类型按文件分组统计数量 |
| getAllName(id) | 获取目录的全路径名称（用.分隔） |
| checkCatalogIsExist(catalogId, type) | 检查目录是否存在且类型匹配 |

---

## 八、Go语言开发参考

### 8.1 关键Go结构体示例

```go
// 目录实体
type Catalog struct {
    ID           int64   `json:"id" gorm:"primaryKey;column:f_id"`
    CatalogName  string  `json:"catalogName" gorm:"column:f_catalog_name"`
    Description  string  `json:"description" gorm:"column:f_description"`
    Level        int     `json:"level" gorm:"column:f_level"`
    ParentID     *int64  `json:"parentId" gorm:"column:f_parent_id"`
    Type         int     `json:"type" gorm:"column:f_type"`
    AuthorityID  string  `json:"authorityId" gorm:"column:f_authority_id"`
    CreateTime   string  `json:"createTime" gorm:"column:f_create_time"`
    CreateUser   string  `json:"createUser" gorm:"column:f_create_user"`
    UpdateTime   string  `json:"updateTime" gorm:"column:f_update_time"`
    UpdateUser   string  `json:"updateUser" gorm:"column:f_update_user"`
    Deleted      int     `json:"deleted" gorm:"column:f_deleted"`
    Children     []Catalog `json:"children,omitempty" gorm:"-"`
}
```

---

## 八、修正说明（v2.1）

本次更新对照 Java 源码进行了以下修正：

### 8.1 目录类型枚举补充
- 新增 Root(0) 根目录类型
- 新增 Other(99) 其他类型

### 8.2 接口清单修正
- 移除了 Java 源码中不存在的接口：PUT /remove（移除目录）、PUT /{id}/state（启用/停用）
- 实际有效接口共 8 个，其中 2 个已废弃

### 8.3 参数校验规则修正
- 创建目录时 `type` 字段不需要传递，自动继承父目录类型
- 修改目录支持移动到新的父目录（parentId）
- 目录名称正则表达式使用 `getRegexENOrCNVarL(1, 20)`
- 修改目录时不允许修改根目录
- 修改目录时新的父目录不能是自身及其子目录

### 8.4 接口参数修正
- 检索目录接口参数名为 `catalog_name` 而非 `keyword`
- 检索目录结果不包含根目录（level > 1）
- 查询目录树接口的 `type` 参数在 `id` 为空时必填

### 8.5 异常提示修正
- 补充了完整的错误码和错误信息
- 删除目录时根据不同类型检查对应的数据是否存在

---

> 文档结束

> 最后更新时间：2026-02-26
> 维护者：Claude Code
> 修正内容：对照 Java 源码完善接口细节
